name: Generate Content
on:
  push:
    branches: [ main ]
    paths:
      - 'README.md'
  schedule:
    - cron: '0 8 * * *' # Roda todo dia √†s 8h UTC
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install google-generativeai

      - name: Extract theme and link from README
        id: extract
        run: |
          TEMA=$(grep -oP '(?<=\*\*TEMA:\*\* ).*' README.md | head -1)
          LINK=$(grep -oP '(?<=\*\*LINK AMAZON:\*\* ).*' README.md | head -1)
          echo "tema=$TEMA" >> $GITHUB_OUTPUT
          echo "link=$LINK" >> $GITHUB_OUTPUT

      - name: Generate content with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat > generate.py << 'PYTHON_SCRIPT'
          import google.generativeai as genai
          import os
          import json
          import sys
          
          # Configurar API
          genai.configure(api_key=os.environ['GEMINI_API_KEY'], transport='rest')
          model = genai.GenerativeModel('gemini-1.5-flash')
          
          # Ler README completo
          with open('README.md', 'r', encoding='utf-8') as f:
              prompt = f.read()
          
          # Gerar conte√∫do
          try:
              response = model.generate_content(
                  prompt,
                  generation_config={
                      'temperature': 0.75,
                      'max_output_tokens': 8192,
                      'response_mime_type': 'application/json'
                  }
              )
              
              # Salvar resultado
              with open('content-output.json', 'w', encoding='utf-8') as f:
                  f.write(response.text)
              
              print("‚úÖ Conte√∫do gerado com sucesso!")
              
          except Exception as e:
              print(f"‚ùå Erro: {e}")
              sys.exit(1)
          PYTHON_SCRIPT
          python generate.py

      - name: Upload generated content
        uses: actions/upload-artifact@v4
        with:
          name: generated-content
          path: content-output.json

      - name: Commit and push if changed
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add -A
          git diff --quiet && git diff --staged --quiet || (git commit -m "ü§ñ Conte√∫do gerado automaticamente" && git push)
